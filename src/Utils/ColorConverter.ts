import { checkTerminalColorSupport } from "./TerminalController";

const LOOK_UP_TABLE = [
    // Primary 3-bit (8 colors). Unique representation!
    { hex: '000000', ansi: 0 },
    { hex: '800000', ansi: 1 },
    { hex: '008000', ansi: 2 },
    { hex: '808000', ansi: 3 },
    { hex: '000080', ansi: 4 },
    { hex: '800080', ansi: 5 },
    { hex: '008080', ansi: 6 },
    { hex: 'c0c0c0', ansi: 7 },

    // Equivalent "bright" versions of original 8 colors.
    { hex: '808080', ansi: 8 },
    { hex: 'ff0000', ansi: 9 },
    { hex: '00ff00', ansi: 10 },
    { hex: 'ffff00', ansi: 11 },
    { hex: '0000ff', ansi: 12 },
    { hex: 'ff00ff', ansi: 13 },
    { hex: '00ffff', ansi: 14 },
    { hex: 'ffffff', ansi: 15 },

    // Strictly ascending.
    { hex: '000000', ansi: 16 },
    { hex: '00005f', ansi: 17 },
    { hex: '000087', ansi: 18 },
    { hex: '0000af', ansi: 19 },
    { hex: '0000d7', ansi: 20 },
    { hex: '0000ff', ansi: 21 },
    { hex: '005f00', ansi: 22 },
    { hex: '005f5f', ansi: 23 },
    { hex: '005f87', ansi: 24 },
    { hex: '005faf', ansi: 25 },
    { hex: '005fd7', ansi: 26 },
    { hex: '005fff', ansi: 27 },
    { hex: '008700', ansi: 28 },
    { hex: '00875f', ansi: 29 },
    { hex: '008787', ansi: 30 },
    { hex: '0087af', ansi: 31 },
    { hex: '0087d7', ansi: 32 },
    { hex: '0087ff', ansi: 33 },
    { hex: '00af00', ansi: 34 },
    { hex: '00af5f', ansi: 35 },
    { hex: '00af87', ansi: 36 },
    { hex: '00afaf', ansi: 37 },
    { hex: '00afd7', ansi: 38 },
    { hex: '00afff', ansi: 39 },
    { hex: '00d700', ansi: 40 },
    { hex: '00d75f', ansi: 41 },
    { hex: '00d787', ansi: 42 },
    { hex: '00d7af', ansi: 43 },
    { hex: '00d7d7', ansi: 44 },
    { hex: '00d7ff', ansi: 45 },
    { hex: '00ff00', ansi: 46 },
    { hex: '00ff5f', ansi: 47 },
    { hex: '00ff87', ansi: 48 },
    { hex: '00ffaf', ansi: 49 },
    { hex: '00ffd7', ansi: 50 },
    { hex: '00ffff', ansi: 51 },
    { hex: '5f0000', ansi: 52 },
    { hex: '5f005f', ansi: 53 },
    { hex: '5f0087', ansi: 54 },
    { hex: '5f00af', ansi: 55 },
    { hex: '5f00d7', ansi: 56 },
    { hex: '5f00ff', ansi: 57 },
    { hex: '5f5f00', ansi: 58 },
    { hex: '5f5f5f', ansi: 59 },
    { hex: '5f5f87', ansi: 60 },
    { hex: '5f5faf', ansi: 61 },
    { hex: '5f5fd7', ansi: 62 },
    { hex: '5f5fff', ansi: 63 },
    { hex: '5f8700', ansi: 64 },
    { hex: '5f875f', ansi: 65 },
    { hex: '5f8787', ansi: 66 },
    { hex: '5f87af', ansi: 67 },
    { hex: '5f87d7', ansi: 68 },
    { hex: '5f87ff', ansi: 69 },
    { hex: '5faf00', ansi: 70 },
    { hex: '5faf5f', ansi: 71 },
    { hex: '5faf87', ansi: 72 },
    { hex: '5fafaf', ansi: 73 },
    { hex: '5fafd7', ansi: 74 },
    { hex: '5fafff', ansi: 75 },
    { hex: '5fd700', ansi: 76 },
    { hex: '5fd75f', ansi: 77 },
    { hex: '5fd787', ansi: 78 },
    { hex: '5fd7af', ansi: 79 },
    { hex: '5fd7d7', ansi: 80 },
    { hex: '5fd7ff', ansi: 81 },
    { hex: '5fff00', ansi: 82 },
    { hex: '5fff5f', ansi: 83 },
    { hex: '5fff87', ansi: 84 },
    { hex: '5fffaf', ansi: 85 },
    { hex: '5fffd7', ansi: 86 },
    { hex: '5fffff', ansi: 87 },
    { hex: '870000', ansi: 88 },
    { hex: '87005f', ansi: 89 },
    { hex: '870087', ansi: 90 },
    { hex: '8700af', ansi: 91 },
    { hex: '8700d7', ansi: 92 },
    { hex: '8700ff', ansi: 93 },
    { hex: '875f00', ansi: 94 },
    { hex: '875f5f', ansi: 95 },
    { hex: '875f87', ansi: 96 },
    { hex: '875faf', ansi: 97 },
    { hex: '875fd7', ansi: 98 },
    { hex: '875fff', ansi: 99 },
    { hex: '878700', ansi: 100 },
    { hex: '87875f', ansi: 101 },
    { hex: '878787', ansi: 102 },
    { hex: '8787af', ansi: 103 },
    { hex: '8787d7', ansi: 104 },
    { hex: '8787ff', ansi: 105 },
    { hex: '87af00', ansi: 106 },
    { hex: '87af5f', ansi: 107 },
    { hex: '87af87', ansi: 108 },
    { hex: '87afaf', ansi: 109 },
    { hex: '87afd7', ansi: 110 },
    { hex: '87afff', ansi: 111 },
    { hex: '87d700', ansi: 112 },
    { hex: '87d75f', ansi: 113 },
    { hex: '87d787', ansi: 114 },
    { hex: '87d7af', ansi: 115 },
    { hex: '87d7d7', ansi: 116 },
    { hex: '87d7ff', ansi: 117 },
    { hex: '87ff00', ansi: 118 },
    { hex: '87ff5f', ansi: 119 },
    { hex: '87ff87', ansi: 120 },
    { hex: '87ffaf', ansi: 121 },
    { hex: '87ffd7', ansi: 122 },
    { hex: '87ffff', ansi: 123 },
    { hex: 'af0000', ansi: 124 },
    { hex: 'af005f', ansi: 125 },
    { hex: 'af0087', ansi: 126 },
    { hex: 'af00af', ansi: 127 },
    { hex: 'af00d7', ansi: 128 },
    { hex: 'af00ff', ansi: 129 },
    { hex: 'af5f00', ansi: 130 },
    { hex: 'af5f5f', ansi: 131 },
    { hex: 'af5f87', ansi: 132 },
    { hex: 'af5faf', ansi: 133 },
    { hex: 'af5fd7', ansi: 134 },
    { hex: 'af5fff', ansi: 135 },
    { hex: 'af8700', ansi: 136 },
    { hex: 'af875f', ansi: 137 },
    { hex: 'af8787', ansi: 138 },
    { hex: 'af87af', ansi: 139 },
    { hex: 'af87d7', ansi: 140 },
    { hex: 'af87ff', ansi: 141 },
    { hex: 'afaf00', ansi: 142 },
    { hex: 'afaf5f', ansi: 143 },
    { hex: 'afaf87', ansi: 144 },
    { hex: 'afafaf', ansi: 145 },
    { hex: 'afafd7', ansi: 146 },
    { hex: 'afafff', ansi: 147 },
    { hex: 'afd700', ansi: 148 },
    { hex: 'afd75f', ansi: 149 },
    { hex: 'afd787', ansi: 150 },
    { hex: 'afd7af', ansi: 151 },
    { hex: 'afd7d7', ansi: 152 },
    { hex: 'afd7ff', ansi: 153 },
    { hex: 'afff00', ansi: 154 },
    { hex: 'afff5f', ansi: 155 },
    { hex: 'afff87', ansi: 156 },
    { hex: 'afffaf', ansi: 157 },
    { hex: 'afffd7', ansi: 158 },
    { hex: 'afffff', ansi: 159 },
    { hex: 'd70000', ansi: 160 },
    { hex: 'd7005f', ansi: 161 },
    { hex: 'd70087', ansi: 162 },
    { hex: 'd700af', ansi: 163 },
    { hex: 'd700d7', ansi: 164 },
    { hex: 'd700ff', ansi: 165 },
    { hex: 'd75f00', ansi: 166 },
    { hex: 'd75f5f', ansi: 167 },
    { hex: 'd75f87', ansi: 168 },
    { hex: 'd75faf', ansi: 169 },
    { hex: 'd75fd7', ansi: 170 },
    { hex: 'd75fff', ansi: 171 },
    { hex: 'd78700', ansi: 172 },
    { hex: 'd7875f', ansi: 173 },
    { hex: 'd78787', ansi: 174 },
    { hex: 'd787af', ansi: 175 },
    { hex: 'd787d7', ansi: 176 },
    { hex: 'd787ff', ansi: 177 },
    { hex: 'd7af00', ansi: 178 },
    { hex: 'd7af5f', ansi: 179 },
    { hex: 'd7af87', ansi: 180 },
    { hex: 'd7afaf', ansi: 181 },
    { hex: 'd7afd7', ansi: 182 },
    { hex: 'd7afff', ansi: 183 },
    { hex: 'd7d700', ansi: 184 },
    { hex: 'd7d75f', ansi: 185 },
    { hex: 'd7d787', ansi: 186 },
    { hex: 'd7d7af', ansi: 187 },
    { hex: 'd7d7d7', ansi: 188 },
    { hex: 'd7d7ff', ansi: 189 },
    { hex: 'd7ff00', ansi: 190 },
    { hex: 'd7ff5f', ansi: 191 },
    { hex: 'd7ff87', ansi: 192 },
    { hex: 'd7ffaf', ansi: 193 },
    { hex: 'd7ffd7', ansi: 194 },
    { hex: 'd7ffff', ansi: 195 },
    { hex: 'ff0000', ansi: 196 },
    { hex: 'ff005f', ansi: 197 },
    { hex: 'ff0087', ansi: 198 },
    { hex: 'ff00af', ansi: 199 },
    { hex: 'ff00d7', ansi: 200 },
    { hex: 'ff00ff', ansi: 201 },
    { hex: 'ff5f00', ansi: 202 },
    { hex: 'ff5f5f', ansi: 203 },
    { hex: 'ff5f87', ansi: 204 },
    { hex: 'ff5faf', ansi: 205 },
    { hex: 'ff5fd7', ansi: 206 },
    { hex: 'ff5fff', ansi: 207 },
    { hex: 'ff8700', ansi: 208 },
    { hex: 'ff875f', ansi: 209 },
    { hex: 'ff8787', ansi: 210 },
    { hex: 'ff87af', ansi: 211 },
    { hex: 'ff87d7', ansi: 212 },
    { hex: 'ff87ff', ansi: 213 },
    { hex: 'ffaf00', ansi: 214 },
    { hex: 'ffaf5f', ansi: 215 },
    { hex: 'ffaf87', ansi: 216 },
    { hex: 'ffafaf', ansi: 217 },
    { hex: 'ffafd7', ansi: 218 },
    { hex: 'ffafff', ansi: 219 },
    { hex: 'ffd700', ansi: 220 },
    { hex: 'ffd75f', ansi: 221 },
    { hex: 'ffd787', ansi: 222 },
    { hex: 'ffd7af', ansi: 223 },
    { hex: 'ffd7d7', ansi: 224 },
    { hex: 'ffd7ff', ansi: 225 },
    { hex: 'ffff00', ansi: 226 },
    { hex: 'ffff5f', ansi: 227 },
    { hex: 'ffff87', ansi: 228 },
    { hex: 'ffffaf', ansi: 229 },
    { hex: 'ffffd7', ansi: 230 },
    { hex: 'ffffff', ansi: 231 },

    // Gray-scale range.
    { hex: '080808', ansi: 232 },
    { hex: '121212', ansi: 233 },
    { hex: '1c1c1c', ansi: 234 },
    { hex: '262626', ansi: 235 },
    { hex: '303030', ansi: 236 },
    { hex: '3a3a3a', ansi: 237 },
    { hex: '444444', ansi: 238 },
    { hex: '4e4e4e', ansi: 239 },
    { hex: '585858', ansi: 240 },
    { hex: '626262', ansi: 241 },
    { hex: '6c6c6c', ansi: 242 },
    { hex: '767676', ansi: 243 },
    { hex: '808080', ansi: 244 },
    { hex: '8a8a8a', ansi: 245 },
    { hex: '949494', ansi: 246 },
    { hex: '9e9e9e', ansi: 247 },
    { hex: 'a8a8a8', ansi: 248 },
    { hex: 'b2b2b2', ansi: 249 },
    { hex: 'bcbcbc', ansi: 250 },
    { hex: 'c6c6c6', ansi: 251 },
    { hex: 'd0d0d0', ansi: 252 },
    { hex: 'dadada', ansi: 253 },
    { hex: 'e4e4e4', ansi: 254 },
    { hex: 'eeeeee', ansi: 255 }
]

export function hexToAnsi(color: string) {
    const hex = color.substring(1);

    const rgb = [
        parseInt(hex.slice(0, 2), 16),
        parseInt(hex.slice(2, 4), 16),
        parseInt(hex.slice(4, 6), 16)
    ];

    const possibleColors = checkTerminalColorSupport() === 256 ? LOOK_UP_TABLE : LOOK_UP_TABLE.slice(0, 8)

    let minDistance = Number.MAX_VALUE;
    let closestColor = 0;

    for(let i = 0; i < possibleColors.length; i++) {
        const ansiRgb = [
            parseInt(possibleColors[i].hex.slice(0, 2), 16),
            parseInt(possibleColors[i].hex.slice(2, 4), 16),
            parseInt(possibleColors[i].hex.slice(4, 6), 16)
        ];

        const distance = Math.pow(rgb[0] - ansiRgb[0], 2) + Math.pow(rgb[1] - ansiRgb[1], 2) + Math.pow(rgb[2] - ansiRgb[2], 2);

        if(distance < minDistance) {
            minDistance = distance;
            closestColor = possibleColors[i].ansi;
        }
    }

    return closestColor;
}